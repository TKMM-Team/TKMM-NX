#!/bin/sh

# TKMM Configuration Script
# This script reads settings from tkmm/config.ini on the SD card

CONFIG_SOURCE="/usr/share/tkmm/config.ini"
CONFIG_DEST="/flash/tkmm/config.ini"

read_config_value() {
    local section="$1"
    local key="$2"
    local default="$3"
    local config_file="/flash/tkmm/config.ini"
    
    if [ -f "$config_file" ]; then
        # Use sed to extract the value more reliably
        local value=$(sed -n "/^\[$section\]/,/^\[/p" "$config_file" | \
                     grep "^[[:space:]]*$key[[:space:]]*=" | \
                     sed 's/^[^=]*=[[:space:]]*//;s/[[:space:]]*$//' | \
                     head -1)
        
        if [ -n "$value" ]; then
            echo "$value"
        else
            echo "$default"
        fi
    else
        echo "$default"
    fi
}

if [ ! -f "$CONFIG_DEST" ]; then
    if [ -f "$CONFIG_SOURCE" ]; then
        cp "$CONFIG_SOURCE" "$CONFIG_DEST"
    else
        echo "Warning: Source config file not found at $CONFIG_SOURCE"
    fi
fi

SCALE_SETTING=$(read_config_value "Display" "scale" "2")
VOLUME_PERCENT=$(read_config_value "Audio" "volume" "40")

case $SCALE_SETTING in
    1) SCALE_FACTOR="0.75x0.75" ;;
    2) SCALE_FACTOR="0.875x0.875" ;;
    3) SCALE_FACTOR="1.25x1.25" ;;
    *) SCALE_FACTOR="0.875x0.875" ;;
esac

export TKMM_SCALE_FACTOR="$SCALE_FACTOR"
export TKMM_VOLUME_PERCENT="$VOLUME_PERCENT"
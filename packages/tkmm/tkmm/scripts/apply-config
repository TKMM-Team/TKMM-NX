#!/bin/bash

# TKMM Configuration Script
# This script sets the volume and display scale based on the config file

# Set ownership and permissions for TKMM
# These may fail on FAT32 partitions, so we ignore errors
chown -R TKMM:TKMM /storage/.net 2>/dev/null || true
chown -R TKMM:TKMM /storage/.tkmm 2>/dev/null || true
chmod -R 755 /storage/.net 2>/dev/null || true
chmod -R 755 /storage/.tkmm 2>/dev/null || true
chmod +x /storage/.tkmm/Tkmm 2>/dev/null || true

rm /run/tkmm_launch.sh
echo '#!/bin/sh' >  /run/tkmm_launch.sh
if  [ -f /storage/.tkmm/Tkmm ]; then
  echo /storage/.tkmm/Tkmm $1 >> /run/tkmm_launch.sh
else
  echo Tkmm $1 >> /run/tkmm_launch.sh
fi
chmod +x /run/tkmm_launch.sh

DEFAULT_VOLUME=40
DEFAULT_SCALE_PERCENT=100

SCALE_PERCENT=$(read-config "Display" "scale" "$DEFAULT_SCALE_PERCENT")
VOLUME_PERCENT=$(read-config "Audio" "volume" "$DEFAULT_VOLUME")
SOUND_CARD_NAME=$(cat /storage/.cache/sound_card)

if ! [ "$SCALE_PERCENT" -ge 50 ] || ! [ "$SCALE_PERCENT" -le 200 ] || ! [ "$SCALE_PERCENT" -eq "$SCALE_PERCENT" ] 2>/dev/null; then
    SCALE_PERCENT=$DEFAULT_SCALE_PERCENT
    echo "Config Error: Scale value is invalid or empty, defaulting to: '$SCALE_PERCENT'"
fi

if ! [ "$VOLUME_PERCENT" -ge 0 ] || ! [ "$VOLUME_PERCENT" -le 100 ] || ! [ "$VOLUME_PERCENT" -eq "$VOLUME_PERCENT" ] 2>/dev/null; then
    VOLUME_PERCENT=$DEFAULT_VOLUME
    echo "Config Error: Volume value is invalid or empty, defaulting to: '$VOLUME_PERCENT'"
fi

if [ "$SCALE_PERCENT" -le 99 ]; then
    SCALE_FACTOR="0.${SCALE_PERCENT}"
else
    SCALE_FACTOR="${SCALE_PERCENT:0:1}.${SCALE_PERCENT:1}"
fi
echo "AVALONIA_GLOBAL_SCALE_FACTOR=$SCALE_FACTOR" > /storage/.cache/env_variables

# set the sound card to configured volume
amixer -c "$SOUND_CARD_NAME" set 'x Speaker' "${VOLUME_PERCENT}%" >/dev/null 2>&1
